<!DOCTYPE html>
<html lang="es">

<head>
    {{> head }}
    <style>
        .location-info {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 10px;
            padding: 12px 16px;
            margin-top: 12px;
            font-size: 0.875rem;
            color: #0369a1;
        }
    </style>
</head>

<body class="bg-body-bg">
    {{> preloader }}
    {{> sidebar }}
    <div class="container-fluid">
        <div class="main-content d-flex flex-column">
            {{> header }}
            <div class="main-content-container overflow-hidden">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4 mt-1">
                    <h3 class="mb-0">Denuncias</h3>

                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb align-items-center mb-0 lh-1">
                            <li class="breadcrumb-item">
                                <a href="/dashboard" class="d-flex align-items-center text-decoration-none">
                                    <i class="ri-home-8-line fs-15 text-primary me-1"></i>
                                    <span class="text-body fs-14 hover">Dashboard</span>
                                </a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                <span class="text-secondary">Denuncias</span>
                            </li>
                        </ol>
                    </nav>
                </div>

                <div class="card bg-white rounded-10 border border-white mb-4" x-data="incidents">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-20">
                        {{> search }}
                        <button @click="openIncidentModal(null)" class="bg-transparent text-primary fs-16 border-0 p-0"
                            x-show="isRegularUser">
                            <i class="material-symbols-outlined fs-16 me-1">add</i>
                            Agregar nueva denuncia
                        </button>
                    </div>

                    <div class="default-table-area mx-minus-1 table-to-do-list">
                        <div class="table-responsive">
                            <table class="table align-middle w-100">
                                <thead>
                                    <tr>
                                        <th scope="col" class="fw-medium">ID</th>
                                        <th scope="col" class="fw-medium">Usuario</th>
                                        <th scope="col" class="fw-medium">Fecha</th>
                                        <th scope="col" class="fw-medium">Tipo</th>
                                        <th scope="col" class="fw-medium">Descripción</th>
                                        <th scope="col" class="fw-medium">Distrito</th>
                                        <th scope="col" class="fw-medium">Estado</th>
                                        <th scope="col" class="fw-medium">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="incident in data.results" :key="incident.id">
                                        <tr>
                                            <td class="text-body" x-text="`#${incident.id}`"></td>
                                            <td class="text-body" x-text="incident.user_name || 'N/A'"></td>
                                            <td class="text-secondary" x-text="formatDate(incident.created_at)"></td>
                                            <td class="text-body" x-text="getTypeText(incident._type)"></td>
                                            <td class="text-body">
                                                <span
                                                    x-text="incident.description.length > 50 ? incident.description.substring(0, 50) + '...' : incident.description"></span>
                                            </td>
                                            <td class="text-body" x-text="incident.district"></td>
                                            <td>
                                                <span
                                                    :class="`${getStatusBadgeClass(incident.status)} bg-opacity-10 fs-15 fw-normal d-inline-block default-badge`"
                                                    x-text="getStatusText(incident.status)">
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex justify-content-end" style="gap: 12px;">
                                                    <button @click="openIncidentModal(incident)"
                                                        class="bg-transparent p-0 border-0 hover-text-success"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="Editar">
                                                        <i
                                                            class="material-symbols-outlined fs-16 fw-normal text-body">edit</i>
                                                    </button>
                                                    <button @click="openDeleteModal(incident)"
                                                        class="bg-transparent p-0 border-0 hover-text-danger"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="Eliminar">
                                                        <i
                                                            class="material-symbols-outlined fs-16 fw-normal text-body">delete</i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="data.results.length === 0">
                                        <td colspan="8" class="text-center text-body py-5">No se encontraron denuncias.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        {{> paginator }}
                    </div>

                    <div class="modal fade" id="deleteIncidentModal" tabindex="-1"
                        aria-labelledby="deleteIncidentModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header"
                                    style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                                    <h5 class="modal-title" id="deleteIncidentModalLabel">
                                        <i class="material-symbols-outlined align-middle"
                                            style="font-size: 24px;">warning</i>
                                        Confirmar Eliminación
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="mb-4 mt-2">
                                        <div class="d-inline-flex align-items-center justify-content-center rounded-circle"
                                            style="width: 80px; height: 80px; background-color: #fee2e2;">
                                            <i class="material-symbols-outlined text-danger"
                                                style="font-size: 48px;">delete_forever</i>
                                        </div>
                                    </div>
                                    <h5 class="mb-3" style="color: #1e293b; font-weight: 600;">
                                        ¿Estás seguro de eliminar esta denuncia?
                                    </h5>
                                    <p class="mb-2" style="color: #475569; font-size: 1rem;">
                                        Denuncia ID: <strong
                                            x-text="incidentToDelete ? `#${incidentToDelete.id}` : ''"></strong>
                                    </p>
                                    <p class="text-muted" style="font-size: 0.875rem;">
                                        Esta acción no se puede deshacer. Todos los datos asociados serán eliminados
                                        permanentemente.
                                    </p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-danger" @click="confirmDelete"
                                        :disabled="deleting">
                                        <span x-show="!deleting">
                                            <i class="material-symbols-outlined align-middle"
                                                style="font-size: 18px;">delete</i>
                                            Eliminar
                                        </span>
                                        <span x-show="deleting">
                                            <span class="spinner-border spinner-border-sm me-1" role="status"
                                                aria-hidden="true"></span>
                                            Eliminando...
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="incidentModal" tabindex="-1" aria-labelledby="incidentModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="incidentModalLabel">
                                        <i class="material-symbols-outlined align-middle" style="font-size: 24px;"
                                            x-text="editingIncident ? 'edit' : 'report'"></i>
                                        <span
                                            x-text="editingIncident ? 'Editar Denuncia' : 'Crear Nueva Denuncia'"></span>
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form @submit.prevent="saveIncident">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <label for="incidentType" class="form-label">
                                                    <i class="material-symbols-outlined align-middle me-1"
                                                        style="font-size: 18px; color: #64748b;">category</i>
                                                    Tipo de Denuncia <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="incidentType"
                                                    x-model="incidentForm._type" required>
                                                    <option value="">Seleccionar tipo...</option>
                                                    <option value="accident">Accidente de tránsito</option>
                                                    <option value="theft">Robo o hurto</option>
                                                    <option value="assault">Agresión o violencia física</option>
                                                    <option value="domestic_violence">Violencia familiar o de pareja
                                                    </option>
                                                    <option value="fraud">Estafa o fraude</option>
                                                    <option value="missing_person">Persona desaparecida</option>
                                                    <option value="vandalism">Vandalismo o daños a la propiedad</option>
                                                    <option value="drug_trafficking">Tráfico o consumo de drogas
                                                    </option>
                                                    <option value="homicide">Homicidio o intento de homicidio</option>
                                                    <option value="harassment">Acoso o amenazas</option>
                                                    <option value="cybercrime">Delito informático</option>
                                                    <option value="sexual_abuse">Abuso o acoso sexual</option>
                                                    <option value="weapon_possession">Tenencia ilegal de armas</option>
                                                    <option value="public_disturbance">Alteración del orden público
                                                    </option>
                                                    <option value="child_abuse">Maltrato infantil</option>
                                                    <option value="animal_abuse">Maltrato animal</option>
                                                    <option value="property_dispute">Conflicto por propiedad</option>
                                                    <option value="corruption">Corrupción o soborno</option>
                                                    <option value="kidnapping">Secuestro o tentativa</option>
                                                    <option value="other">Otro tipo de denuncia</option>
                                                </select>
                                                <span x-text="error._type" class="text-danger"></span>
                                            </div>

                                            <div class="col-12">
                                                <label for="incidentDescription" class="form-label">
                                                    <i class="material-symbols-outlined align-middle me-1"
                                                        style="font-size: 18px; color: #64748b;">description</i>
                                                    Descripción <span class="text-danger">*</span>
                                                </label>
                                                <textarea class="form-control" id="incidentDescription"
                                                    x-model="incidentForm.description" rows="4" required
                                                    placeholder="Describe detalladamente lo ocurrido..."></textarea>
                                                <span x-text="error.description" class="text-danger"></span>
                                            </div>

                                            <div class="col-md-6">
                                                <label for="incidentRegion" class="form-label">
                                                    <i class="material-symbols-outlined align-middle me-1"
                                                        style="font-size: 18px; color: #64748b;">location_on</i>
                                                    Región <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" id="incidentRegion"
                                                    x-model="incidentForm.region" required>
                                                    <option value="">Seleccionar región...</option>
                                                    <option value="Amazonas">Amazonas</option>
                                                    <option value="Ancash">Ancash</option>
                                                    <option value="Apurimac">Apurímac</option>
                                                    <option value="Arequipa">Arequipa</option>
                                                    <option value="Ayacucho">Ayacucho</option>
                                                    <option value="Cajamarca">Cajamarca</option>
                                                    <option value="Callao">Callao</option>
                                                    <option value="Cusco">Cusco</option>
                                                    <option value="Huancavelica">Huancavelica</option>
                                                    <option value="Huanuco">Huánuco</option>
                                                    <option value="Ica">Ica</option>
                                                    <option value="Junin">Junín</option>
                                                    <option value="La Libertad">La Libertad</option>
                                                    <option value="Lambayeque">Lambayeque</option>
                                                    <option value="Lima">Lima</option>
                                                    <option value="Loreto">Loreto</option>
                                                    <option value="Madre de Dios">Madre de Dios</option>
                                                    <option value="Moquegua">Moquegua</option>
                                                    <option value="Pasco">Pasco</option>
                                                    <option value="Piura">Piura</option>
                                                    <option value="Puno">Puno</option>
                                                    <option value="San Martin">San Martín</option>
                                                    <option value="Tacna">Tacna</option>
                                                    <option value="Tumbes">Tumbes</option>
                                                    <option value="Ucayali">Ucayali</option>
                                                </select>
                                                <span x-text="error.region" class="text-danger"></span>
                                            </div>

                                            <div class="col-md-6">
                                                <label for="incidentDistrict" class="form-label">
                                                    <i class="material-symbols-outlined align-middle me-1"
                                                        style="font-size: 18px; color: #64748b;">map</i>
                                                    Distrito <span class="text-danger">*</span>
                                                </label>
                                                <input type="text" class="form-control" id="incidentDistrict"
                                                    x-model="incidentForm.district" required
                                                    placeholder="Ej: Miraflores">
                                                <span x-text="error.district" class="text-danger"></span>
                                            </div>

                                            <div class="col-12 mt-4">
                                                <div>
                                                    <h6 class="mb-3 text-white" style="font-weight: 600;">
                                                        <i class="material-symbols-outlined align-middle me-2"
                                                            style="font-size: 20px; color: #0f79f3;">location_searching</i>
                                                        Ubicación del Incidente
                                                    </h6>
                                                    <button type="button" @click="getLocation()"
                                                        class="btn btn-outline-primary" :disabled="gettingLocation"
                                                        style="border-radius: 10px;">
                                                        <span x-show="!gettingLocation">
                                                            <i class="material-symbols-outlined align-middle me-1"
                                                                style="font-size: 18px;">my_location</i>
                                                            Obtener Coordenadas
                                                        </span>
                                                        <span x-show="gettingLocation">
                                                            <span class="spinner-border spinner-border-sm me-1"
                                                                role="status" aria-hidden="true"></span>
                                                            Obteniendo ubicación...
                                                        </span>
                                                    </button>

                                                    <div x-show="incidentForm.lat && incidentForm.lon"
                                                        class="location-info">
                                                        <i class="material-symbols-outlined align-middle me-1"
                                                            style="font-size: 18px;">check_circle</i>
                                                        <strong>Coordenadas guardadas:</strong><br>
                                                        Latitud: <span x-text="incidentForm.lat"></span><br>
                                                        Longitud: <span x-text="incidentForm.lon"></span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-12 mt-4">
                                                <div>
                                                    <h6 class="mb-3 text-white" style="font-weight: 600;">
                                                        <i class="material-symbols-outlined align-middle me-2"
                                                            style="font-size: 20px; color: #0f79f3;">photo_library</i>
                                                        Evidencias (Imágenes o Videos)
                                                    </h6>
                                                    
                                                    <div class="mb-3">
                                                        <label for="evidenceFiles" class="btn btn-outline-secondary" style="cursor: pointer; border-radius: 10px;">
                                                            <i class="material-symbols-outlined align-middle me-1" style="font-size: 18px;">upload_file</i>
                                                            Seleccionar archivos
                                                        </label>
                                                        <input type="file" class="d-none" id="evidenceFiles" 
                                                            @change="handleFileSelect($event)" 
                                                            accept="image/*,video/*" 
                                                            multiple>
                                                        
                                                        <button type="button" 
                                                            @click="uploadEvidenceOnly()" 
                                                            class="btn btn-success ms-2" 
                                                            style="border-radius: 10px;"
                                                            x-show="editingIncident && hasNewEvidence"
                                                            :disabled="uploadingEvidence">
                                                            <span x-show="!uploadingEvidence">
                                                                <i class="material-symbols-outlined align-middle me-1" style="font-size: 18px;">cloud_upload</i>
                                                                Subir Evidencias
                                                            </span>
                                                            <span x-show="uploadingEvidence">
                                                                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                                                Subiendo...
                                                            </span>
                                                        </button>
                                                        
                                                        <small class="text-muted d-block mt-2">
                                                            Formatos aceptados: JPG, PNG, GIF, WEBP, MP4, AVI, MOV, WMV, FLV, WEBM (Máx. 50MB por archivo)
                                                        </small>
                                                    </div>

                                                    <div class="row g-3" x-show="evidenceFiles.length > 0">
                                                        <template x-for="(evidence, index) in evidenceFiles" :key="index">
                                                            <div class="col-md-4">
                                                                <div class="card border" style="border-radius: 10px; overflow: hidden;">
                                                                    <div class="position-relative">
                                                                        <template x-if="isImage(evidence)">
                                                                            <img :src="evidence.file_url" 
                                                                                class="card-img-top" 
                                                                                style="height: 150px; object-fit: cover;" 
                                                                                :alt="evidence.name">
                                                                        </template>
                                                                        <template x-if="isVideo(evidence)">
                                                                            <video :src="evidence.file_url" 
                                                                                class="card-img-top" 
                                                                                style="height: 150px; object-fit: cover;" 
                                                                                controls>
                                                                            </video>
                                                                        </template>
                                                                        <button type="button" 
                                                                            @click="removeEvidence(index)"
                                                                            class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2"
                                                                            style="border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                                                            <i class="material-symbols-outlined" style="font-size: 18px;">close</i>
                                                                        </button>
                                                                    </div>
                                                                    <div class="card-body p-2">
                                                                        <p class="mb-0 small text-truncate" x-text="evidence.name"></p>
                                                                        <span class="badge bg-primary" x-text="evidence.file_type === 'image' ? 'Imagen' : 'Video'"></span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>

                                                    <div x-show="evidenceFiles.length === 0" class="text-center text-muted py-4" style="border: 2px dashed #dee2e6; border-radius: 10px;">
                                                        <i class="material-symbols-outlined mb-2" style="font-size: 48px; opacity: 0.5;">photo_library</i>
                                                        <p class="mb-0">No se han agregado evidencias</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-12 mt-3" x-show="editingIncident">
                                                <label for="incidentStatus" class="form-label">
                                                    <i class="material-symbols-outlined align-middle me-1"
                                                        style="font-size: 18px; color: #64748b;">toggle_on</i>
                                                    Estado
                                                </label>
                                                <select class="form-select" id="incidentStatus"
                                                    x-model="incidentForm.status">
                                                    <option value="Pending">Pendiente</option>
                                                    <option value="In Progress">En Progreso</option>
                                                    <option value="Resolved">Resuelto</option>
                                                </select>
                                                <span x-text="error.status" class="text-danger"></span>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                                <span x-text="error.non_field_errors" class="text-danger text-center px-4"></span>

                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="material-symbols-outlined align-middle me-1"
                                            style="font-size: 18px;">close</i>
                                        Cancelar
                                    </button>
                                    <button type="button" class="btn btn-primary" style="color: #fff;" @click="saveIncident"
                                        :disabled="saving">
                                        <span x-show="!saving">
                                            <i class="material-symbols-outlined align-middle me-1"
                                                style="font-size: 18px;" x-text="editingIncident ? 'check' : 'add'"></i>
                                            <span x-text="editingIncident ? 'Actualizar' : 'Crear'"></span>
                                        </span>
                                        <span x-show="saving">
                                            <span class="spinner-border spinner-border-sm me-1" role="status"
                                                aria-hidden="true"></span>
                                            <span x-text="editingIncident ? 'Actualizando...' : 'Creando...'"></span>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="deleteEvidenceModal" tabindex="-1"
                        aria-labelledby="deleteEvidenceModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header"
                                    style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                                    <h5 class="modal-title" id="deleteEvidenceModalLabel">
                                        <i class="material-symbols-outlined align-middle"
                                            style="font-size: 24px;">warning</i>
                                        Confirmar Eliminación de Evidencia
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <div class="mb-4 mt-2">
                                        <div class="d-inline-flex align-items-center justify-content-center rounded-circle"
                                            style="width: 80px; height: 80px; background-color: #fee2e2;">
                                            <i class="material-symbols-outlined text-danger"
                                                style="font-size: 48px;">delete_forever</i>
                                        </div>
                                    </div>
                                    <h5 class="mb-3" style="color: #1e293b; font-weight: 600;">
                                        ¿Estás seguro de eliminar esta evidencia?
                                    </h5>
                                    <p class="text-muted" style="font-size: 0.875rem;">
                                        Esta acción no se puede deshacer. El archivo será eliminado permanentemente.
                                    </p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-danger" @click="confirmDeleteEvidence"
                                        :disabled="deletingEvidence">
                                        <span x-show="!deletingEvidence">
                                            <i class="material-symbols-outlined align-middle"
                                                style="font-size: 18px;">delete</i>
                                            Eliminar
                                        </span>
                                        <span x-show="deletingEvidence">
                                            <span class="spinner-border spinner-border-sm me-1" role="status"
                                                aria-hidden="true"></span>
                                            Eliminando...
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="flex-grow-1"></div>
        {{> footer }}
    </div>
    </div>
    <script type="module" src="/assets/js/actions/incidents.js"></script>
    {{> scripts }}
</body>

</html>